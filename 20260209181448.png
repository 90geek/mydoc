# 3C6000系列 LCL/PCIe 调试指南（从 PHY 到 Controller）

<!-- toc -->

- [0. 调试总原则（必须遵守）](#0-%E8%B0%83%E8%AF%95%E6%80%BB%E5%8E%9F%E5%88%99%E5%BF%85%E9%A1%BB%E9%81%B5%E5%AE%88)
  * [0.5 常见现象快速定位](#05-%E5%B8%B8%E8%A7%81%E7%8E%B0%E8%B1%A1%E5%BF%AB%E9%80%9F%E5%AE%9A%E4%BD%8D)
  * [常见错误做法](#%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF%E5%81%9A%E6%B3%95)
- [1. PHY 层调试（电气与训练基础）](#1-phy-%E5%B1%82%E8%B0%83%E8%AF%95%E7%94%B5%E6%B0%94%E4%B8%8E%E8%AE%AD%E7%BB%83%E5%9F%BA%E7%A1%80)
  * [1.1 PHY 是否 Ready](#11-phy-%E6%98%AF%E5%90%A6-ready)
  * [1.2 Lane 状态检查（关键步骤）](#12-lane-%E7%8A%B6%E6%80%81%E6%A3%80%E6%9F%A5%E5%85%B3%E9%94%AE%E6%AD%A5%E9%AA%A4)
  * [1.3 进入 compliance 发包（TX 眼图）](#13-%E8%BF%9B%E5%85%A5-compliance-%E5%8F%91%E5%8C%85tx-%E7%9C%BC%E5%9B%BE)
- [2. LTSSM 调试（链路状态机）](#2-ltssm-%E8%B0%83%E8%AF%95%E9%93%BE%E8%B7%AF%E7%8A%B6%E6%80%81%E6%9C%BA)
  * [2.1 抓取 LTSSM 状态](#21-%E6%8A%93%E5%8F%96-ltssm-%E7%8A%B6%E6%80%81)
  * [2.2 LTSSM 卡死态 → 直接对照表](#22-ltssm-%E5%8D%A1%E6%AD%BB%E6%80%81-%E2%86%92-%E7%9B%B4%E6%8E%A5%E5%AF%B9%E7%85%A7%E8%A1%A8)
  * [2.3 LTSSM 常用状态编码速查](#23-ltssm-%E5%B8%B8%E7%94%A8%E7%8A%B6%E6%80%81%E7%BC%96%E7%A0%81%E9%80%9F%E6%9F%A5)
- [3. 重传与误码分析（Link 健康度）](#3-%E9%87%8D%E4%BC%A0%E4%B8%8E%E8%AF%AF%E7%A0%81%E5%88%86%E6%9E%90link-%E5%81%A5%E5%BA%B7%E5%BA%A6)
  * [3.1 PCIe 链路重传误码规范参考](#31-pcie-%E9%93%BE%E8%B7%AF%E9%87%8D%E4%BC%A0%E8%AF%AF%E7%A0%81%E8%A7%84%E8%8C%83%E5%8F%82%E8%80%83)
- [4. Controller 层调试（协议与功能）](#4-controller-%E5%B1%82%E8%B0%83%E8%AF%95%E5%8D%8F%E8%AE%AE%E4%B8%8E%E5%8A%9F%E8%83%BD)
  * [4.1 能力是否被正确协商](#41-%E8%83%BD%E5%8A%9B%E6%98%AF%E5%90%A6%E8%A2%AB%E6%AD%A3%E7%A1%AE%E5%8D%8F%E5%95%86)
  * [4.2 AER 是否已有错误积累](#42-aer-%E6%98%AF%E5%90%A6%E5%B7%B2%E6%9C%89%E9%94%99%E8%AF%AF%E7%A7%AF%E7%B4%AF)
  * [4.3 控制器序调试与问题定位（数据错 / 中断不同步）](#43-%E6%8E%A7%E5%88%B6%E5%99%A8%E5%BA%8F%E8%B0%83%E8%AF%95%E4%B8%8E%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D%E6%95%B0%E6%8D%AE%E9%94%99--%E4%B8%AD%E6%96%AD%E4%B8%8D%E5%90%8C%E6%AD%A5)
- [X. 何时应立即回退到 PHY / SI](#x-%E4%BD%95%E6%97%B6%E5%BA%94%E7%AB%8B%E5%8D%B3%E5%9B%9E%E9%80%80%E5%88%B0-phy--si)
- [5. 调试闭环总结](#5-%E8%B0%83%E8%AF%95%E9%97%AD%E7%8E%AF%E6%80%BB%E7%BB%93)
- [6. 快速调参清单](#6-%E5%BF%AB%E9%80%9F%E8%B0%83%E5%8F%82%E6%B8%85%E5%8D%95)
  * [6.1 设备无法识别（`lspci` 看不到）](#61-%E8%AE%BE%E5%A4%87%E6%97%A0%E6%B3%95%E8%AF%86%E5%88%ABlspci-%E7%9C%8B%E4%B8%8D%E5%88%B0)
  * [6.2 只能 Link 到 Gen1（Gen2/Gen3/Gen4 起不来）](#62-%E5%8F%AA%E8%83%BD-link-%E5%88%B0-gen1gen2gen3gen4-%E8%B5%B7%E4%B8%8D%E6%9D%A5)
  * [6.3 首次 Gen4 训练不稳定，导致后续无法训练](#63-%E9%A6%96%E6%AC%A1-gen4-%E8%AE%AD%E7%BB%83%E4%B8%8D%E7%A8%B3%E5%AE%9A%E5%AF%BC%E8%87%B4%E5%90%8E%E7%BB%AD%E6%97%A0%E6%B3%95%E8%AE%AD%E7%BB%83)
  * [6.4 训练后链路不稳定（可 Link 但易抖动/降级/掉线）](#64-%E8%AE%AD%E7%BB%83%E5%90%8E%E9%93%BE%E8%B7%AF%E4%B8%8D%E7%A8%B3%E5%AE%9A%E5%8F%AF-link-%E4%BD%86%E6%98%93%E6%8A%96%E5%8A%A8%E9%99%8D%E7%BA%A7%E6%8E%89%E7%BA%BF)
  * [6.5 使用建议](#65-%E4%BD%BF%E7%94%A8%E5%BB%BA%E8%AE%AE)
- [7. 单页排障流程图](#7-%E5%8D%95%E9%A1%B5%E6%8E%92%E9%9A%9C%E6%B5%81%E7%A8%8B%E5%9B%BE)
  * [7.1 单页速查表（现象 -> 下一步）](#71-%E5%8D%95%E9%A1%B5%E9%80%9F%E6%9F%A5%E8%A1%A8%E7%8E%B0%E8%B1%A1---%E4%B8%8B%E4%B8%80%E6%AD%A5)
  * [7.2 现场执行规则（精简）](#72-%E7%8E%B0%E5%9C%BA%E6%89%A7%E8%A1%8C%E8%A7%84%E5%88%99%E7%B2%BE%E7%AE%80)

<!-- tocstop -->

- 编写：钱东彦
- 协作: 李昱辰 吴胜
- 更新日期：2026-02-04 禁止外传扩散
>
> 适用平台：Loongson 6000 系列（PCIe / LCL）  
> 适用对象：物理层 / 控制器协议 / 硬件 / 固件 / 内核 联合调试  
> 目标：建立 **PHY → Link → Controller → Software** 的清晰调试路径，快速定位问题层级

本指南不是功能说明书  
也不是 PCIe 协议教学

本文只回答一个问题：  
“现在这个问题，应该在哪一层停下来继续查？”

---

## 0. 调试总原则（必须遵守）

PCIe 调试必须**自底向上**，严格遵循以下顺序：

```
PHY → Lane → LTSSM → Link → Transaction → Software
```

层级含义（简要）：
- PHY：电气/时钟/训练基础是否正常
- Lane：逐 Lane 物理状态（L0/LOS/L1/EQ/误码）
- LTSSM：链路状态机是否按期望推进/稳定
- Link：链路层可靠性（重传/重放/流控健康）
- Transaction：TLP 事务语义（排序、一致性、完成包等）
- Software：枚举、驱动、配置与业务逻辑

注：如“写不越过读”这类 TLP 包序/一致性规则属于 Transaction Layer 语义，
控制器是否遵守该规则是事务层问题，而非链路层问题。

### 0.5 常见现象快速定位

| 现象 | 优先检查 |
|----|----|
| lspci 完全看不到设备 | PERST / PHY Ready / 连接状态 |
| 设备偶尔消失 | LTSSM 抖动 / Lane 掉 PHY不稳 |
| 能枚举但速率降级 | EQ / Margin PHY不稳 / 状态机|
| 压力下卡死 | 重传 / Replay | 事务层序拥堵 |
| 性能远低于预期 | MPS / MRRS 不合理, etc.. |

### 常见错误做法
- ❌ 链路未建就看 lspci
- ❌ LTSSM 不稳定就调 BAR / MSI
- ❌ 误码很多直接怀疑驱动

> **规则：没进 L0，一律不看控制器；没稳住速率，一律不看性能**

---

## 1. PHY 层调试（电气与训练基础）

### 1.1 PHY 是否 Ready

检查要点：
- PERST# 是否释放
- PHY 电源、时钟是否正常
- PLL 是否 Lock
- TX / RX 是否 Enable

判断结论：
- PHY 未 ready：LTSSM 只能停在 `DETECT_*`
- PHY 异常：后续LTSSM状态机一直recovery 所有调试结果均不可信

补充：每个 3C die 提供 PHY0/1/2/3，其中 PHY1/2/3 与 LCL1/2/3 复用。可根据手册在固件源码接口内拆分 x16/x8/x4，并配置上限 GEN4/3/2/1 速率。

---

### 1.2 Lane 状态检查（关键步骤）

使用工具：

OsTools：
```bash
wget https://raw.githubusercontent.com/MarsDoge/OsTools/master/OsTools
LCL: ./OsTools lcl -c -n <node> -m 1
```
用途：检测 LCL 重传误码以及链路状态。

重点关注：
- 每条 Lane 是否 LO 以及链路通道状态机指示速率带宽
- EQ 是否完成
- Lane 误码是否持续增长

判断标准：

| 现象 | 结论 |
|----|----|
| 单 Lane 长期 LOS | SI / PHY 问题 |
| EQ 失败或反复 | Preset / Margin |
| 多 Lane 不一致 | Lane Mask / 拓扑 |
| 全部稳定 | 允许进入 LTSSM |

---

### 1.3 进入 compliance 发包（TX 眼图）

工具脚本：
```bash
wget https://raw.githubusercontent.com/MarsDoge/OsTools/master/Script/pcie_enter_compliance.sh
```

用法：
```bash
sudo ./pcie_enter_compliance.sh  A  B  preset
# A=BDF (domain:bus:dev.func),  B=1-4  gen1/2/3/4  0-10
```

说明：PCIe 设置进入 compliance 发包，用于测试 TX 眼图工具。

---

## 2. LTSSM 调试（链路状态机）

### 2.1 抓取 LTSSM 状态

```bash
chmod +x dump_loong_pcie_ltssm.sh
./dump_loong_pcie_ltssm.sh
```

脚本说明：
```bash
wget https://raw.githubusercontent.com/MarsDoge/OsTools/master/Script/dump_loong_pcie_ltssm.sh
```
用途：检测 PCIe 重传误码以及链路状态。

### 2.2 LTSSM 卡死态 → 直接对照表

| LTSSM 状态 | 高概率原因 |
|----|----|
| Detect | PHY / PERST |
| Polling | Lane ?|
| Config | ? EQ |
| Recovery | Margin / 误码 |
| L0 ↔ Recovery | SI / 重传 |

### 2.3 LTSSM 常用状态编码速查

| 状态名 | 编码 |
|----|----|
| `DETECT_QUIET` | `0x00` |
| `DETECT_ACT` | `0x01` |
| `RCVRY_LOCK` | `0x0d` |
| `RCVRY_RCVRCFG` | `0x0f` |
| `RCVRY_IDLE` | `0x10` |
| `L0` | `0x11` |
| `L0s` | `0x12` |
| `RCVRY_EQ2` | `0x22` |
| `RCVRY_EQ3` | `0x23` |

说明: 详细状态机不在此展开

---

## 3. 重传与误码分析（Link 健康度）

```bash
val1=$(devmem 0xXXXXXXXX)
sleep 10
val2=$(devmem 0xXXXXXXXX)
echo $((val2 - val1))
```

### 3.1 PCIe 链路重传误码规范参考

REF: PCIe 要求最多 `1e12` 个传输 bit（1000 Gb）允许重传误码 1 次。  
说明：以上为线速近似，未扣编码开销。  
可按吞吐换算为「满载情况下可接受的重传间隔」：

- Gen4 x16：`16 GT/s * 16 lane ≈ 256 Gbps`  
  `1000 Gb / 256 Gbps ≈ 4 s`，即 x16 满载约 4 秒允许错 1 次  
  实际设备举例：100 Gbps 网卡跑满时  
  `1000 Gb / 100 Gbps = 10 s`，即约 10 秒可接受错 1 次
- Gen4 x8：`16 GT/s * 8 lane ≈ 128 Gbps`  
  `1000 Gb / 128 Gbps ≈ 8 s`，即 x8 满载约 8 秒允许错 1 次

---

## 4. Controller 层调试（协议与功能）

```bash
lspci -vv
```

### 4.1 能力是否被正确协商

- Max Speed / Width
- MPS / MRRS

### 4.2 AER 是否已有错误积累

- Correctable ≠ 没问题

### 4.3 控制器序调试与问题定位（数据错 / 中断不同步）

典型现象：
- 数据内容偶发错误，但链路看起来稳定
- 中断先到但数据未就绪，或数据已更新但中断滞后

先决条件（避免误判）：
- 先确认第 2/3 章无明显异常（LTSSM 不抖动、Replay 不持续线性增长）
- 只要链路质量有问题，优先回退 PHY/SI，不要先改序约束

定位步骤（建议顺序）：
1. 先加最小延时，验证是否与时序窗口相关（中断前后、门铃前后、DMA 提交后）
2. 对关键寄存器读写点加时间戳，确认“写数据 -> 写门铃/发中断 -> 对端读到数据”的真实先后
3. 打开/调整控制器序约束后 A/B 对比，观察错误是否收敛

常用序约束策略（按需启用）：

| 场景 | 建议约束 |
|----|----|
| P 写后仍有依赖动作 | `P` 等待前序 `P` 发送/完成（防止 posted 写松散外发） |
| P 与 NP 并发导致先后异常 | 视场景配置 `P` 不越过 `NP`；对性能敏感路径可评估允许越过 |
| 读到旧数据 | 读请求等待相关写完成（Read-after-Write 同步） |
| 连续写覆盖/乱序可见 | 写请求等待前序写完成（Write-after-Write 同步） |
| 中断与数据不同步 | 门铃/中断前增加写完成等待或短延时，再触发中断 |

工程建议：
- 先“保守序”（正确性优先）确认问题消失，再逐步放松约束回收性能
- 每次只改一个开关或一个等待点，记录吞吐/时延/错误率三项指标
- 若“加延时有效、去延时复现”，基本可判定为序/同步窗口问题

---

## X. 何时应立即回退到 PHY / SI

- LTSSM 频繁退回 Recovery
- Replay Counter 持续线性增长
- 不同设备插槽表现差异巨大
- 降速后问题消失

---

## 5. 调试闭环总结

> **LTSSM 决定能不能建链  
> 重传决定链路质量  
> Controller 决定功能是否正确**

---

## 6. 快速调参清单

本节用于“现象明确、需要快速试参”的场景。  
默认前提：已按本文前序章节完成基础排查（PERST/时钟/供电/LTSSM 基本可推进）。

### 6.1 设备无法识别（`lspci` 看不到）

按顺序尝试：
- 减小 Gen1 TX 阻抗（`comp_tx_gen1`），最小可调到 `0x11`
- 若仍无效，减小信号检测阈值（`wait_sigdet`），最小可调到 `0x1`

### 6.2 只能 Link 到 Gen1（Gen2/Gen3/Gen4 起不来）

按顺序尝试：
- 若设备插在 `1X8_2X4` 模式最后一个 `X4` 槽位，检查是否使用 `8G` 时钟（`gen3_use_4g`），未配置则设为 `0x2`
- 减小信号检测阈值（`wait_sigdet`），最小可调到 `0x1`

### 6.3 首次 Gen4 训练不稳定，导致后续无法训练

按顺序尝试：
- 调整设备 Gen4 preset（`rtx_preset_g4`）
- 优先尝试 `3/4/5`，若无效再覆盖测试 `0~9` 其他值

### 6.4 训练后链路不稳定（可 Link 但易抖动/降级/掉线）

按顺序尝试：
- 调整 preset 训练范围（`preset_train`），常用 `0x6/0x7`
- 减小 DFE 训练范围（`dfe_train`）
- 增加 boost 训练范围（`boost_train`），如 `0x7/0xf`
- 增加 VGA 训练范围（`vga_train`），如 `0x0f00`

### 6.5 使用建议

- 每次只改一个参数，保留“参数值 -> LTSSM/误码/是否稳定”的记录
- 先保证“稳定建链”，再回头优化速率与性能
- 若参数扫描后仍失败，回退到第 1/2/3 章按层重查 SI/PHY 基础条件

---

## 7. 单页排障流程图

> 目标：快速决策。  
> 原则：不跳层；先“能稳定建链”，再“谈性能和功能”。

```mermaid
flowchart TD
    A[症状入口] --> A1{lspci能看到设备?}
    A1 -- 否 --> P1[PHY基础检查\nPERST/电源/时钟/PLL Lock/TXRX Enable]
    P1 --> P2{PHY Ready?}
    P2 -- 否 --> P3[修复硬件与时序后重试]
    P2 -- 是 --> P4[Lane检查\nLOS/EQ/误码/Lane一致性]
    P4 --> P5{Lane稳定?}
    P5 -- 否 --> P6[优先SI/拓扑/Mask/阈值参数]
    P5 -- 是 --> L1[进入LTSSM分析]

    A1 -- 是 --> L1[进入LTSSM分析]
    L1 --> L2{是否稳定L0?}
    L2 -- 否 --> L3[对照卡死态\nDetect/Polling/Config/Recovery]
    L3 --> L4[定位到PHY或训练参数后重测]
    L2 -- 是 --> R1[重传/误码计数]

    R1 --> R2{Replay增长是否异常?}
    R2 -- 是 --> R3[回退PHY/SI\n必要时降速验证]
    R2 -- 否 --> C1[Controller层检查]

    C1 --> C2[协商能力\nSpeed/Width/MPS/MRRS]
    C2 --> C3[流控与AER\nCredit/Completion/AER]
    C3 --> T1{是否存在数据错/中断不同步?}
    T1 -- 是 --> T2[事务层序检查\nP/NP/CPL 顺序与可见性]
    T2 --> T3[优先保守序\n读等写/写等写/中断前写完成]
    T3 --> T4{问题消失?}
    T4 -- 否 --> C5[事务层/驱动联合定位]
    T4 -- 是 --> Z1[结案: 固化序约束与基线]
    T1 -- 否 --> C4{功能是否正常?}
    C4 -- 否 --> C5[Controller/驱动联合定位]
    C4 -- 是 --> Z1[结案: 记录配置与计数基线]
```

### 7.1 单页速查表（现象 -> 下一步）

| 现象 | 下一步（只做最先一项） |
|----|----|
| `lspci` 看不到设备 | 先查 `PERST/PLL Lock/PHY Ready` |
| 偶发掉设备 | 先抓 LTSSM 是否 `L0<->Recovery` 抖动 |
| 只能到 Gen1 | 先查 Lane/EQ，再看 `gen3_use_4g` 与 `wait_sigdet` |
| 首次 Gen4 不稳定 | 先试 `rtx_preset_g4=3/4/5` |
| 压力下卡死/吞吐抖动 | 先看 Replay 是否线性增长 |
| 数据错或中断与数据不同步 | 先查事务层序：`P/NP/CPL`，并启用“读等写/中断前写完成”做 A/B |
| AER 有 Correctable | 先结合 Replay 与 LTSSM，不能直接判“无问题” |
| 降速后恢复稳定 | 立即回退 PHY/SI 路径，不要先改驱动 |

### 7.2 现场执行规则（精简）

- 一次只改一个变量，改完立刻复测并记录
- 没进稳定 `L0` 前，不进入 Controller/驱动优化
- 先“稳定性”后“速率”再“性能”
